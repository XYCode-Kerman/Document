---
sidebar_position: 7
---

# Python 异步教程

Python 从 3.4 开始引入了 asyncio 库，提供异步并发支持，从 Python 3.4 到 3.7，对异步的支持一直在不断地进步。可以说，异步就是 Python 未来的趋势之一。

在了解异步之前，你可能已经接触过或听说过很多类似的概念，比如“并发”“并行”“多线程”等等，这么多名词，再加上一个“异步”，让人有些混乱。

不过，虽然看起来很复杂，但是，通过这篇教程，我相信你能够对“异步”有一个清晰的把握。

以下是这篇教程涵盖的内容：

 - 异步：一种编程范式，独立于编程语言，可以具有多种语言的不同实现。
 - async/await：两个新的 Python 关键字，用于定义协程。
 - asyncio：Python 包，提供异步的基础功能和管理协程的 API。

那么，让我们开始吧。

## 什么是异步？

异步是实现并发的一种方式。这里的并发，指的是多个任务同时运行。

举一个生活中的场景：

你在网上下载一个文件，但是文件很大，需要很长时间才能下完。这时候，你肯定不会盯着进度条一点点走，而是去做点别的事情，比如读一会书，看一会电影，~~造一个轮子，~~等等。

放到程序运行也是一样。有的时候我们需要发送网络请求，却不想把时间浪费在等待网络返回上，这时候就需要有能够**“同时”运行多个任务**的方式。

多线程是最容易想到的一种方式了。我们可以把网络请求的部分放在一个单独的线程中，这样就可以在等待网络返回的时候，在其他线程里运行另外的任务。

而异步则是另一种解决方式，它允许你只用一个工作线程，达到运行多个任务的效果。

为什么可以只用一个线程？让我们重新看一下多线程的实现：

我们用一个线程发送网络请求，在等待网络返回的时候，这个线程实际上是“空闲”的。**如果这时候，我们能够把这个线程用来做其他事情，就完全不需要再用别的线程了**。

怎样才能让一个线程在等待时做其他的工作呢？我们可以有一个比较理想的实现：发出网络请求后，把这一部分“暂停”，保存工作状态，然后跳转到别处去，做其他的工作，等到其他工作完成之后，再恢复被“暂停”的状态，继续等待网络请求返回。

这其实就是异步的思想。**在一个线程中，通过控制流的切换，达到运行多个任务的效果**。

## 异步的实现

在我们刚才谈论的异步的实现方式中，有一个关键之处：我们需要一种可以“暂停”与“继续”的函数。

我们把这种特殊的函数称为“协程”。**协程可以在运行过程中，把自己“暂停”，然后交出控制流，来运行其他的任务。等到其他任务全部执行完成，或者全部其他任务也交出控制流之后，再恢复自己的运行**。

只是这么说，并不能揭示异步到底是用怎样的方式实现的。下面，我就说明一下 Python 的 asyncio 的简化的运行原理。

**在 Python 中，正在运行的协程称为任务（Task），由事件循环（event loop）负责调度**。

**事件循环会维护一个任务队列，其中有在当前线程运行的全部任务**。每次，事件循环会运行任务队列中的一个任务。如果任务完成，事件循环会把它从任务队列中删除。如果任务中途交出控制权，它会被暂停，然后放到队列末尾，事件循环会接着运行其他的任务。

至于协程是怎么做到中途暂停的，这又是另一个问题了。实际上，在协程之前，Python 已经有可以暂停的函数了，那就是生成器。实际上，在早期版本，asyncio 就是使用生成器来实现协程的暂停的。当然，基于生成器的协程有诸多不便，在后来的版本中已经弃用了，不过借助生成器来理解其中的原理。还是可以的。

这里要澄清一个误区：**协程交出控制流并不是自动的，不是遇到堵塞的代码，控制流就会被自动交出。协程交出控制流，是需要在代码中明确写出的**。就像生成器暂停需要用 `yield` 关键字一样，协程遇到 `await` 关键字才可能会交出控制流。

## Python 的异步实现

从 Python 3.5 开始，有了2个新的关键字 async 和 await，用于异步操作。

```python
import asyncio

async def hello():
    print('Hello world!')
    await asyncio.sleep(1)
    print('Hello again!')
```

关键字 async 主要用在 async def 中，表示这个函数是一个异步函数，它的返回值是一个协程对象。

**协程对象在刚被创建的时候是不会运行的**。要想让协程运行，可以有下面的几种方式：

1. 使用 `await` 关键字等待协程。
2. 使用 `asyncio.create_task()` 函数，将协程包装成 Task，放入事件循环。
3. 使用 `asyncio.run()` 函数，将协程放入事件循环。

🚧施工中🚧